<!DOCTYPE html>
<html lang="en-US">

  <head>
    <!-- General meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    
      <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Human following robot | Maciej Stępień</title>
<meta name="generator" content="Jekyll v4.3.0" />
<meta property="og:title" content="Human following robot" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Lidar-based legs detection and tracking and people following implemented on Husarion’s ROSbot 2" />
<meta property="og:description" content="Lidar-based legs detection and tracking and people following implemented on Husarion’s ROSbot 2" />
<link rel="canonical" href="http://localhost:5000/robots/2019/09/24/human-following-robot/" />
<meta property="og:url" content="http://localhost:5000/robots/2019/09/24/human-following-robot/" />
<meta property="og:site_name" content="Maciej Stępień" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-09-24T00:00:00+00:00" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:5000/pics/logo1.png"}},"description":"Lidar-based legs detection and tracking and people following implemented on Husarion’s ROSbot 2","@type":"BlogPosting","headline":"Human following robot","dateModified":"2019-09-24T00:00:00+00:00","datePublished":"2019-09-24T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:5000/robots/2019/09/24/human-following-robot/"},"url":"http://localhost:5000/robots/2019/09/24/human-following-robot/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    
    

    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#242e2b"/>

    
      <link rel="stylesheet" href="/assets/styles.css">
    

    

    

    


    <!-- Overwrite this file with code you want before the closing head tag -->

  </head>

  <body class="layout-post  human-following-robot">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="height: 0; position: absolute">
  <symbol id="codepen" viewBox="0 0 16 16"><path d="M15.988 5.443c-.004-.02-.007-.04-.012-.058l-.01-.033c-.006-.017-.012-.034-.02-.05-.003-.012-.01-.023-.014-.034l-.023-.045-.02-.032-.03-.04-.024-.03c-.01-.013-.022-.026-.034-.038l-.027-.027-.04-.032-.03-.024-.012-.01L8.38.117c-.23-.155-.53-.155-.76 0L.305 4.99.296 5c-.012.007-.022.015-.032.023-.014.01-.027.02-.04.032l-.027.027-.034.037-.024.03-.03.04c-.006.012-.013.022-.02.033l-.023.045-.015.034c-.007.016-.012.033-.018.05l-.01.032c-.005.02-.01.038-.012.058l-.006.03C.002 5.5 0 5.53 0 5.56v4.875c0 .03.002.06.006.09l.007.03c.003.02.006.04.013.058l.01.033c.006.018.01.035.018.05l.015.033c.006.016.014.03.023.047l.02.03c.008.016.018.03.03.042.007.01.014.02.023.03.01.012.02.025.034.036.01.01.018.02.028.026l.04.033.03.023.01.01 7.31 4.876c.116.078.248.117.382.116.134 0 .266-.04.38-.116l7.314-4.875.01-.01c.012-.007.022-.015.032-.023.014-.01.027-.02.04-.032l.027-.027.034-.037.024-.03.03-.04.02-.032.023-.046.015-.033.018-.052.01-.033c.005-.02.01-.038.013-.058 0-.01.003-.02.004-.03.004-.03.006-.06.006-.09V5.564c0-.03-.002-.06-.006-.09l-.007-.03zM8 9.626L5.568 8 8 6.374 10.432 8 8 9.626zM7.312 5.18l-2.98 1.993-2.406-1.61 5.386-3.59v3.206zM3.095 8l-1.72 1.15v-2.3L3.095 8zm1.237.828l2.98 1.993v3.208l-5.386-3.59 2.406-1.61zm4.355 1.993l2.98-1.993 2.407 1.61-5.387 3.59v-3.206zM12.905 8l1.72-1.15v2.3L12.905 8zm-1.237-.827L8.688 5.18V1.97l5.386 3.59-2.406 1.61z" fill-rule="nonzero"/></symbol>
  <symbol id="dribbble" viewBox="0 0 16 16"><path d="M8 16c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm6.747-6.905c-.234-.074-2.115-.635-4.257-.292.894 2.456 1.258 4.456 1.328 4.872 1.533-1.037 2.624-2.68 2.93-4.58zM10.67 14.3c-.102-.6-.5-2.688-1.46-5.18l-.044.014C5.312 10.477 3.93 13.15 3.806 13.4c1.158.905 2.614 1.444 4.194 1.444.947 0 1.85-.194 2.67-.543zm-7.747-1.72c.155-.266 2.03-3.37 5.555-4.51.09-.03.18-.056.27-.08-.173-.39-.36-.778-.555-1.16C4.78 7.85 1.47 7.807 1.17 7.8l-.003.208c0 1.755.665 3.358 1.756 4.57zM1.31 6.61c.307.005 3.122.017 6.318-.832-1.132-2.012-2.353-3.705-2.533-3.952-1.912.902-3.34 2.664-3.784 4.785zM6.4 1.368c.188.253 1.43 1.943 2.548 4 2.43-.91 3.46-2.293 3.582-2.468C11.323 1.827 9.736 1.176 8 1.176c-.55 0-1.087.066-1.6.19zm6.89 2.322c-.145.194-1.29 1.662-3.816 2.694.16.325.31.656.453.99.05.117.1.235.147.352 2.274-.286 4.533.172 4.758.22-.015-1.613-.59-3.094-1.543-4.257z"/></symbol>
  <symbol id="designernews" viewBox="0 0 16 16"><path d="M7.514 7.988c0-2.555-1.57-4.287-4.56-4.287H0v8.6h3.016c2.903 0 4.498-1.75 4.498-4.31zM5.37 8c0 1.844-.946 2.642-2.467 2.642H2.13V5.358h.773C4.36 5.358 5.37 6.193 5.37 8zM16 12.3V3.7h-1.98v4.81L10.853 3.7h-2.07v8.6h1.982V7.152l3.39 5.146H16z"/></symbol>
  <symbol id="facebook" viewBox="0 0 16 16"><path d="M15.117 0H.883C.395 0 0 .395 0 .883v14.234c0 .488.395.883.883.883h7.663V9.804H6.46V7.39h2.086V5.607c0-2.066 1.262-3.19 3.106-3.19.883 0 1.642.064 1.863.094v2.16h-1.28c-1 0-1.195.476-1.195 1.176v1.54h2.39l-.31 2.416h-2.08V16h4.077c.488 0 .883-.395.883-.883V.883C16 .395 15.605 0 15.117 0" fill-rule="nonzero"/></symbol>
  <symbol id="flickr" viewBox="0 0 16 16"><path d="M0 8c0 2.05 1.662 3.71 3.71 3.71 2.05 0 3.713-1.66 3.713-3.71S5.76 4.29 3.71 4.29C1.663 4.29 0 5.95 0 8zm8.577 0c0 2.05 1.662 3.71 3.712 3.71C14.337 11.71 16 10.05 16 8s-1.662-3.71-3.71-3.71c-2.05 0-3.713 1.66-3.713 3.71z"/></symbol>
  <symbol id="github" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.083-.202-.358-1.015.077-2.117 0 0 .672-.215 2.2.82.638-.178 1.323-.266 2.003-.27.68.004 1.364.092 2.003.27 1.527-1.035 2.198-.82 2.198-.82.437 1.102.163 1.915.08 2.117.513.56.823 1.274.823 2.147 0 3.073-1.87 3.75-3.653 3.947.287.246.543.735.543 1.48 0 1.07-.01 1.933-.01 2.195 0 .215.144.463.55.385C13.71 14.53 16 11.534 16 8c0-4.418-3.582-8-8-8"/></symbol>
  <symbol id="hackernews" viewBox="0 0 16 16"><path d="M0 0v16h16V0H0zm8.92 8.96v3H7.25v-3l-2.75-5h1.96l1.66 3.48L9.7 3.96h1.88l-2.66 5z"/></symbol>
  <symbol id="instagram" viewBox="0 0 16 16"><path d="M8 0C5.827 0 5.555.01 4.702.048 3.85.088 3.27.222 2.76.42c-.526.204-.973.478-1.417.923-.445.444-.72.89-.923 1.417-.198.51-.333 1.09-.372 1.942C.008 5.555 0 5.827 0 8s.01 2.445.048 3.298c.04.852.174 1.433.372 1.942.204.526.478.973.923 1.417.444.445.89.72 1.417.923.51.198 1.09.333 1.942.372.853.04 1.125.048 3.298.048s2.445-.01 3.298-.048c.852-.04 1.433-.174 1.942-.372.526-.204.973-.478 1.417-.923.445-.444.72-.89.923-1.417.198-.51.333-1.09.372-1.942.04-.853.048-1.125.048-3.298s-.01-2.445-.048-3.298c-.04-.852-.174-1.433-.372-1.942-.204-.526-.478-.973-.923-1.417-.444-.445-.89-.72-1.417-.923-.51-.198-1.09-.333-1.942-.372C10.445.008 10.173 0 8 0zm0 1.44c2.136 0 2.39.01 3.233.048.78.036 1.203.166 1.485.276.374.145.64.318.92.598.28.28.453.546.598.92.11.282.24.705.276 1.485.038.844.047 1.097.047 3.233s-.01 2.39-.048 3.233c-.036.78-.166 1.203-.276 1.485-.145.374-.318.64-.598.92-.28.28-.546.453-.92.598-.282.11-.705.24-1.485.276-.844.038-1.097.047-3.233.047s-2.39-.01-3.233-.048c-.78-.036-1.203-.166-1.485-.276-.374-.145-.64-.318-.92-.598-.28-.28-.453-.546-.598-.92-.11-.282-.24-.705-.276-1.485C1.45 10.39 1.44 10.136 1.44 8s.01-2.39.048-3.233c.036-.78.166-1.203.276-1.485.145-.374.318-.64.598-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276C5.61 1.45 5.864 1.44 8 1.44zm0 2.452c-2.27 0-4.108 1.84-4.108 4.108 0 2.27 1.84 4.108 4.108 4.108 2.27 0 4.108-1.84 4.108-4.108 0-2.27-1.84-4.108-4.108-4.108zm0 6.775c-1.473 0-2.667-1.194-2.667-2.667 0-1.473 1.194-2.667 2.667-2.667 1.473 0 2.667 1.194 2.667 2.667 0 1.473-1.194 2.667-2.667 2.667zm5.23-6.937c0 .53-.43.96-.96.96s-.96-.43-.96-.96.43-.96.96-.96.96.43.96.96z"/></symbol>
  <symbol id="linkedin" viewBox="0 0 16 16"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51V7.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"/></symbol>
  <symbol id="medium" viewBox="0 0 16 16"><path d="M11.824 12.628l-.276.45.798.398 2.744 1.372c.15.076.294.11.418.11.278 0 .467-.177.467-.492V5.883l-4.15 6.745zm4.096-8.67c-.004-.003 0-.01-.003-.012l-4.825-2.412c-.06-.03-.123-.038-.187-.044-.016 0-.03-.01-.047-.01-.184 0-.368.092-.467.254l-.24.39-.5.814-1.89 3.08 1.89 3.076.5.813.5.812.59.95 4.71-7.64c.02-.03.01-.06-.02-.08zm-6.27 7.045L7.17 6.97l-.295-.477-.294-.477-.25-.416v4.867l3.32 1.663.5.25.5.25-.5-.813-.5-.813zM.737 1.68L.59 1.608c-.085-.042-.166-.062-.24-.062-.206 0-.35.16-.35.427v10.162c0 .272.2.594.442.716l4.145 2.08c.107.06.208.08.3.08.257 0 .438-.2.438-.53V4.01c0-.02-.012-.04-.03-.047L.738 1.68z"/></symbol>
  <symbol id="pinterest" viewBox="0 0 16 16"><path d="M8 0C3.582 0 0 3.582 0 8c0 3.39 2.108 6.285 5.084 7.45-.07-.633-.133-1.604.028-2.295.146-.625.938-3.977.938-3.977s-.24-.48-.24-1.188c0-1.11.646-1.943 1.448-1.943.683 0 1.012.513 1.012 1.127 0 .687-.436 1.713-.662 2.664-.19.797.4 1.445 1.185 1.445 1.42 0 2.514-1.498 2.514-3.662 0-1.915-1.376-3.254-3.342-3.254-2.276 0-3.61 1.707-3.61 3.472 0 .687.263 1.424.593 1.825.066.08.075.15.057.23-.06.252-.196.796-.223.907-.035.146-.115.178-.268.107-.998-.465-1.624-1.926-1.624-3.1 0-2.524 1.834-4.84 5.287-4.84 2.774 0 4.932 1.977 4.932 4.62 0 2.757-1.74 4.977-4.153 4.977-.81 0-1.572-.422-1.833-.92l-.5 1.902c-.18.695-.667 1.566-.994 2.097.75.232 1.545.357 2.37.357 4.417 0 8-3.582 8-8s-3.583-8-8-8z" fill-rule="nonzero"/></symbol>
  <symbol id="rss" viewBox="0 0 16 16"><path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.985 2.194-2.196 2.194C.984 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"/></symbol>
  <symbol id="reddit" viewBox="0 0 16 16"><path d="M1.473 9.368c-.04.185-.06.374-.06.566 0 2.3 2.94 4.173 6.554 4.173 3.613 0 6.553-1.872 6.553-4.173 0-.183-.02-.364-.055-.54l-.01-.022c-.013-.036-.02-.073-.02-.11-.2-.784-.745-1.497-1.533-2.072-.03-.01-.058-.026-.084-.047-.017-.013-.03-.028-.044-.043-1.198-.824-2.91-1.34-4.807-1.34-1.88 0-3.576.506-4.772 1.315-.01.012-.02.023-.033.033-.026.022-.056.04-.087.05-.805.576-1.364 1.293-1.572 2.086 0 .038-.01.077-.025.114l-.005.01zM8 13.003c-1.198 0-2.042-.26-2.58-.8-.116-.116-.116-.305 0-.422.117-.11.307-.11.424 0 .42.42 1.125.63 2.155.63 1.03 0 1.73-.2 2.15-.62.11-.11.3-.11.42 0 .11.12.11.31 0 .43-.54.54-1.38.8-2.58.8zM5.592 7.945c-.61 0-1.12.51-1.12 1.12 0 .608.51 1.102 1.12 1.102.61 0 1.103-.494 1.103-1.102 0-.61-.494-1.12-1.103-1.12zm4.83 0c-.61 0-1.12.51-1.12 1.12 0 .608.51 1.102 1.12 1.102.61 0 1.103-.494 1.103-1.102 0-.61-.494-1.12-1.103-1.12zM13.46 6.88c.693.556 1.202 1.216 1.462 1.94.3-.225.48-.578.48-.968 0-.67-.545-1.214-1.214-1.214-.267 0-.52.087-.728.243zM1.812 6.64c-.67 0-1.214.545-1.214 1.214 0 .363.16.7.43.927.268-.72.782-1.37 1.478-1.92-.202-.14-.443-.22-.694-.22zm6.155 8.067c-3.944 0-7.152-2.14-7.152-4.77 0-.183.016-.363.046-.54-.53-.33-.86-.91-.86-1.545 0-1 .82-1.812 1.82-1.812.45 0 .87.164 1.2.455 1.24-.796 2.91-1.297 4.75-1.33l1.21-3.69.27.063s.01 0 .01.002l2.82.663c.23-.533.76-.908 1.38-.908.82 0 1.49.67 1.49 1.492 0 .823-.67 1.492-1.49 1.492s-1.49-.67-1.49-1.49L9.4 2.18l-.98 2.99c1.77.07 3.37.57 4.57 1.35.33-.31.764-.48 1.225-.48 1 0 1.814.81 1.814 1.81 0 .66-.36 1.26-.92 1.58.02.17.04.33.04.5-.01 2.63-3.21 4.77-7.16 4.77zM13.43 1.893c-.494 0-.895.4-.895.894 0 .493.4.894.894.894.49 0 .89-.4.89-.89s-.4-.89-.9-.89z"/></symbol>
  <symbol id="skype" viewBox="0 0 16 16"><path d="M8.035 12.6c-2.685 0-3.885-1.322-3.885-2.313 0-.51.374-.865.89-.865 1.15 0 .85 1.653 2.995 1.653 1.096 0 1.703-.597 1.703-1.208 0-.368-.18-.775-.904-.954l-2.387-.597C4.524 7.833 4.175 6.79 4.175 5.812c0-2.034 1.91-2.798 3.704-2.798 1.65 0 3.6.916 3.6 2.136 0 .523-.452.827-.97.827-.98 0-.798-1.36-2.773-1.36-.98 0-1.523.444-1.523 1.08 0 .636.774.84 1.446.993l1.767.392c1.936.433 2.427 1.566 2.427 2.633 0 1.652-1.266 2.886-3.82 2.886m7.4-3.264l-.014.084-.028-.16c.015.024.028.05.042.076.082-.45.125-.912.125-1.373 0-1.023-.2-2.014-.595-2.948-.38-.902-.925-1.712-1.62-2.407-.692-.696-1.5-1.242-2.4-1.623C10.015.59 9.025.39 8.005.39c-.48 0-.963.045-1.43.135H6.57l.08.04-.16-.023.08-.016C5.927.183 5.205 0 4.472 0 3.278 0 2.155.466 1.31 1.313.465 2.16 0 3.286 0 4.483c0 .763.195 1.512.563 2.175l.013-.083.028.16c-.015-.026-.027-.052-.04-.077-.076.43-.115.867-.115 1.305 0 1.022.2 2.014.593 2.948.38.903.925 1.713 1.62 2.408.693.695 1.5 1.242 2.4 1.623.932.397 1.92.597 2.94.597.445 0 .89-.04 1.325-.118l-.077-.043.162.028-.084.014c.67.378 1.426.58 2.2.58 1.194 0 2.317-.466 3.162-1.313.845-.846 1.31-1.972 1.31-3.17 0-.765-.197-1.517-.566-2.18" fill-rule="nonzero"/></symbol>
  <symbol id="tumblr" viewBox="0 0 16 16"><path d="M9.708 16c-3.396 0-4.687-2.504-4.687-4.274V6.498H3.403V4.432C5.83 3.557 6.412 1.368 6.55.12c.01-.086.077-.12.115-.12H9.01v4.076h3.2v2.422H8.997v4.98c.01.667.25 1.58 1.472 1.58h.067c.424-.012.994-.136 1.29-.278l.77 2.283c-.288.424-1.594.916-2.77.936h-.12z" fill-rule="nonzero"/></symbol>
  <symbol id="twitch" viewBox="0 0 16 16"><g fill-rule="nonzero"><path d="M1.393 0L.35 2.783v11.13h3.824V16h2.088l2.085-2.088h3.13L15.65 9.74V0H1.394zm1.39 1.39H14.26v7.653l-2.435 2.435H8l-2.085 2.085v-2.085H2.783V1.39z"/><path d="M6.61 8.348H8V4.175H6.61v4.173zm3.824 0h1.39V4.175h-1.39v4.173z"/></g></symbol>
  <symbol id="twitter" viewBox="0 0 16 16"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.375-1.337.648-2.085.795-.598-.638-1.45-1.036-2.396-1.036-1.812 0-3.282 1.468-3.282 3.28 0 .258.03.51.085.75C5.152 5.39 2.733 4.084 1.114 2.1.83 2.583.67 3.147.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.416-.02-.617-.058.418 1.304 1.63 2.253 3.067 2.28-1.124.88-2.54 1.404-4.077 1.404-.265 0-.526-.015-.783-.045 1.453.93 3.178 1.474 5.032 1.474 6.038 0 9.34-5 9.34-9.338 0-.143-.004-.284-.01-.425.64-.463 1.198-1.04 1.638-1.7z" fill-rule="nonzero"/></symbol>
  <symbol id="vimeo" viewBox="0 0 16 16"><path d="M15.992 4.275c-.07 1.56-1.16 3.697-3.263 6.41-2.176 2.832-4.017 4.248-5.522 4.248-.933 0-1.722-.862-2.367-2.588L3.55 7.6c-.48-1.724-.993-2.587-1.542-2.587-.12 0-.538.252-1.255.755L0 4.796C.79 4.1 1.568 3.406 2.335 2.71c1.053-.912 1.844-1.39 2.37-1.44 1.246-.12 2.012.733 2.3 2.56.31 1.97.526 3.194.647 3.673.36 1.634.754 2.45 1.185 2.45.335 0 .838-.53 1.51-1.59.67-1.06 1.028-1.866 1.076-2.42.096-.915-.263-1.374-1.077-1.374-.383 0-.778.087-1.185.262.788-2.58 2.29-3.834 4.508-3.762 1.644.048 2.42 1.116 2.324 3.205z" fill-rule="nonzero"/></symbol>
  <symbol id="youtube" viewBox="0 0 16 16"><path d="M0 7.345c0-1.294.16-2.59.16-2.59s.156-1.1.636-1.587c.608-.637 1.408-.617 1.764-.684C3.84 2.36 8 2.324 8 2.324s3.362.004 5.6.166c.314.038.996.04 1.604.678.48.486.636 1.588.636 1.588S16 6.05 16 7.346v1.258c0 1.296-.16 2.59-.16 2.59s-.156 1.102-.636 1.588c-.608.638-1.29.64-1.604.678-2.238.162-5.6.166-5.6.166s-4.16-.037-5.44-.16c-.356-.067-1.156-.047-1.764-.684-.48-.487-.636-1.587-.636-1.587S0 9.9 0 8.605v-1.26zm6.348 2.73V5.58l4.323 2.255-4.32 2.24h-.002z"/></symbol>
  <symbol id="link" viewBox="0 0 16 16"><path d="M5.86 12.7l-.81.8c-.7.7-1.84.7-2.54 0a1.75 1.75 0 0 1 0-2.5l2.98-2.96c.61-.61 1.77-1.52 2.62-.68a1 1 0 1 0 1.4-1.4c-1.44-1.43-3.57-1.17-5.42.67L1.1 9.6a3.72 3.72 0 0 0 0 5.32 3.78 3.78 0 0 0 5.34 0l.8-.8a1 1 0 1 0-1.39-1.42zm9.03-11.5c-1.55-1.53-3.7-1.6-5.14-.19l-1 1a1 1 0 1 0 1.39 1.41l1-1c.75-.74 1.72-.43 2.35.2a1.75 1.75 0 0 1 0 2.5l-3.17 3.15c-1.46 1.45-2.14.77-2.43.48a1 1 0 0 0-1.4 1.4c.67.67 1.43 1 2.23 1 .98 0 2.01-.5 3-1.47l3.17-3.15a3.72 3.72 0 0 0 0-5.32z"/></symbol>
  <symbol id="email" viewBox="0 0 16 11"><path fill-rule="evenodd" d="M1.33 0h13.34L8 5 1.33 0zM16 0v11H0V0l8 6 8-6z"/></symbol>
  <symbol id="nav" viewBox="0 0 16 11"><path d="M0 12h16v-2H0v2zm0-5h16V5H0v2zm0-7v2h16V0H0z"/></symbol>
</svg>


    <header class="header">
  <div class="container">
    <a class="logo" href="/">
  <img src="/pics/logo1.png" alt="Maciej Stępień logo"/>
</a>


    
<nav class="nav  nav--header">
  <ul class="list  list--nav">
    

      

      <li class="item  item--nav">
        <a href="/home/">Home</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/about/">About</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/">Projects</a>
      </li>
    

      

      <li class="item  item--nav">
        <a href="/categories/">Categories</a>
      </li>
    
  </ul>
  <button class="button  button--nav" aria-label="Menu toggle">
    <svg width="16" height="16" class="icon  icon--nav" role="img" alt="Menu"><title>Menu</title><use xlink:href="#nav" fill="CurrentColor"></use></svg>

  </button>
</nav>


<script type="text/javascript">
  // Get list and button
  const navList = document.querySelector('.header .list--nav')
  const button  = document.querySelector('.header .button--nav')

  // Hide nav and apply toggle
  const collapseNav = () => {
    if (document.body.clientWidth < 640) {
      navList.style.setProperty('--listHeight', `-${navList.offsetHeight}px`)
    } else {
      navList.removeAttribute('style')
    }

    button.onclick = () => {
      navList.style.setProperty('transition', `margin .1s`)
      if (navList.style.getPropertyValue('--listHeight')) {
        navList.style.removeProperty('--listHeight')
      } else {
        navList.style.setProperty('--listHeight', `-${navList.offsetHeight}px`)
      }
    }
  }

  collapseNav()

  // Check on resize if to collapse nav
  window.addEventListener('resize', () => {
    collapseNav()
  })
</script>

  </div>

  






</header>


<main class="main  container">

  <article class="article  article--post  content  typeset">

    <h1>Human following robot</h1>
    

<small class="small  post-meta">
  
  
    
      <span class="label  label--category"><a href="/categories/#robots">Robots</a></span>
    
  &nbsp;&middot;&nbsp;<time datetime="2019-09-24T00:00:00+00:00" class="time">24 Sep 2019</time>
</small>

    <p><a class="button" href="https://github.com/macstepien/rosbot_follower" style="background: #0366d6">Github repository  <svg width="16" height="16" class="icon  icon--github" role="img" alt="github"><title>github</title><use xlink:href="#github" fill="CurrentColor"></use></svg>
</a></p>

<p>In this tutorial I describe one way to make robot detect and follow people - it won’t make a great spy but could be useful to carry luggage or groceries. Whole system was implemented on Husarion’s ROSbot 2 with ESP32 as a remote. To find people I used scans from LiDAR (RPLidar A2) with my leg detector, which is simple but turned out to be fast and quite reliable.
<!-- I also checked other LiDAR approaches available on ROS - leg_detector and leg_tracker but in this case didn't perform well enough. Another package I tested is upper_body_detector, which uses RGBD camera to detect humans. As name suggests it needs to see upper part of body - this will be a problem if we want our robot to stay close, also in this case it didn't perform very well and was slower. --></p>

<div class="video">
  <iframe src="https://www.youtube.com/embed/u0uAg5_CGms" frameborder="0" allowfullscreen="" title="ROSbot follower demo"></iframe>
</div>

<h2 id="setup">Setup</h2>

<h3 id="esp32-remote">ESP32 Remote</h3>

<h4 id="environment">Environment</h4>

<p>You will need to follow tutorial about <a href="https://www.hackster.io/khasreto/run-rosserial-over-the-internet-with-esp32-0615f5">setting up rosserial connection over Internet with ESP32</a>. On ROSbot prepare Husarnet connection and Rosserial for Husarnet. I recommend to set up Arduino IDE on your computer (remember to also get Rosserial for Husarnet).</p>

<h4 id="code">Code</h4>

<p>Create new sketch in Arduino IDE and copy code:<br />
<a href="https://github.com/macstepien/RosbotFollowerESPRemote/blob/master/rosbot_remote.ino">ESP Remote Code</a></p>

<p>Then get your Husarnet join code and customize code as described in <a href="https://www.hackster.io/khasreto/run-rosserial-over-the-internet-with-esp32-0615f5">ESP32 Husarnet Tutorial</a></p>

<h4 id="wiring">Wiring</h4>

<p>Wire your ESP32 accordingly to schematics:</p>

<figure class="figure  figure--center">
  <img class="image" src="/pics/13_human_following_robot/remoteSchematics.png" alt="" width="600" height="800" />
  
</figure>

<p>As a source of power you can use a Powerbank connected to the ESP.</p>

<h3 id="rosbot">ROSbot</h3>

<p>This project is meant to run on CORE2 with Mbed firmware. So be sure that you updated your firmware as described in <a href="https://husarion.com/tutorials/howtostart/rosbot---quick-start/">ROSbot quick start</a>. On ROSbot you will need to install following dependencies:</p>

<ul>
  <li><strong>scikit-learn</strong> python library (for clusterization)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>python-scikits-learn
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>pykalman</strong><br />
Follow installation tutorial on <a href="https://pykalman.github.io/">pykalman page</a></p>
  </li>
  <li><strong>rosbot_description</strong> package (for URDF visualization model and bridge node)<br />
Go to your ROS workspace and clone repository:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/ros_workspace/src
git clone https://github.com/husarion/rosbot_description.git
</code></pre></div>    </div>
    <p>Install dependencies:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/ros_workspace
rosdep <span class="nb">install</span> <span class="nt">--from-paths</span> src <span class="nt">--ignore-src</span> <span class="nt">-r</span> <span class="nt">-y</span>
</code></pre></div>    </div>
  </li>
  <li><strong>rosbot_ekf</strong><br />
Install dependency:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>ros-kinetic-robot-localization
</code></pre></div>    </div>
    <p>Get package:</p>
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/byq77/rosbot_ekf.git
</code></pre></div>    </div>
  </li>
</ul>

<p>Then go back to src folder in your workspace:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/ros_workspace/src
</code></pre></div></div>

<p>Download code:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/macstepien/rosbot_follower.git
</code></pre></div></div>

<p>And finally build your workspace:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/ros_workspace
catkin_make
</code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>There are two options available:</p>

<ul>
  <li>followerSlow - better if you have little space and walk slowly.<br />
To run it you only need to copy this commande into new terminal window:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>roslaunch rosbot_follower followerSlow.launch
</code></pre></div>    </div>
  </li>
  <li>followerKalman - this one should be able to follow you with normal walking, but it also needs some space to gain speed.<br />
Roslaunch command:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>roslaunch rosbot_follower followerKalman.launch
</code></pre></div>    </div>
  </li>
</ul>

<p>After whole system is up and running stand in front of ROSbot, but not too far away. When you are detected blue LED on ESP should turn on. Then you can press first button (the one closer to ESP on schematics) and if you start walking robot should follow you. When LED turns off it means that algorithm lost detection of you and need to recalibrate (stand closer to robot and wait until blue LED is back on). If robot had false detection you can calibrate again by pressing second button. On RViz you can see visualization: scan from LiDAR, robot model and detections. Green spheres are all potential legs, blue cylinders are detected legs and red tall cylinder is human position. In version with Kalman filter we also publish circle around human, which shows how much estimated position differs from measurement.</p>

<figure class="figure  figure--center">
  <img class="image" src="/pics/13_human_following_robot/rviz.png" alt="" width="600" height="800" />
  
</figure>

<h3 id="troubleshooting">Troubleshooting</h3>

<ul>
  <li><strong>LED doesn’t turn on</strong> - check RViz if you can see detected human (red cylinder). If there is a detection then press Dead Man’s Button and try to walk.</li>
  <li><strong>ROSbot doesn’t respond</strong> - you should check your connection to ESP32. You can do so by echoing button topic:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rostopic <span class="nb">echo</span> /esp_remote/start
</code></pre></div>    </div>
    <p>If nothing can be seen, try restarting your ESP by turning it off and on again.</p>
  </li>
</ul>

<h2 id="algorithm-walkthrough">Algorithm walkthrough</h2>

<p>First we will go through slower version, as it is simpler. Main part of this code is scan callback where all the magic happens - data from LiDAR is analyzed and people are detected. Whole process consists of 5 steps:</p>

<ol>
  <li>Clusterization</li>
  <li>Leg detection</li>
  <li>Human detection</li>
  <li>Marker publishing</li>
  <li>Control</li>
</ol>

<h3 id="1-clusterization">1. Clusterization</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="n">clusterList</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">findClusters</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>First we find clusters in our scan using Euclidean Clusterization Algorithm:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">findClusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="n">pointsList</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">.</span><span class="n">ranges</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">minRange</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">maxRange</span><span class="p">:</span>
            <span class="n">alfa</span> <span class="o">=</span> <span class="n">scan</span><span class="p">.</span><span class="n">angle_min</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">scan</span><span class="p">.</span><span class="n">angle_increment</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfa</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">alfa</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="ow">and</span> <span class="n">alfa</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">maxAngle</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="p">(</span><span class="n">alfa</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">maxAngle</span> <span class="ow">and</span> <span class="n">alfa</span> <span class="o">&lt;</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span><span class="p">):</span>
                <span class="n">pointsList</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">pointsList</span><span class="p">,</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">minRange</span><span class="p">:</span>
            <span class="n">rospy</span><span class="p">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">"Obstacle detected"</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">clusterizationMaxDistanceParam</span><span class="p">,</span>
                <span class="n">min_samples</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">clusterizationMinSamplesParam</span><span class="p">).</span><span class="n">fit</span><span class="p">(</span><span class="n">pointsList</span><span class="p">)</span>
    <span class="n">core_samples_mask</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">db</span><span class="p">.</span><span class="n">labels_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">core_samples_mask</span><span class="p">[</span><span class="n">db</span><span class="p">.</span><span class="n">core_sample_indices_</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">labels_</span>
    <span class="n">n_clusters_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">clusterList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">:</span>
        <span class="n">class_member_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">pointsList</span><span class="p">[</span><span class="n">class_member_mask</span> <span class="o">&amp;</span> <span class="n">core_samples_mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xy</span><span class="p">.</span><span class="nb">any</span><span class="p">():</span>
            <span class="n">clusterList</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clusterList</span>
</code></pre></div></div>

<p>Here we have few parameters that you can customize:</p>

<ul>
  <li><strong>minRange</strong> - used to filter ranges from lidar points, if anything gets closer than that, then ROSbot treats it as obstacle and stops</li>
  <li><strong>maxRange</strong> - data from lidar further than that value are dismissed</li>
  <li><strong>maxAngle</strong> - readings have to be in front of ROSbot in ranges (maxAngle, Pi) u (-Pi, -maxAngle)</li>
  <li><strong>clusterizationMaxDistanceParam</strong> - maximum distance between points to add new point to cluster</li>
  <li><strong>clusterizationMinSamplesParam</strong> - minimum number of points in cluster</li>
</ul>

<p>More information about <a href="https://scikit-learn.org/stable/modules/clustering.html#dbscan">DBSCAN clusterization</a></p>

<p>Back to scanCallback:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusterList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    	<span class="n">rospy</span><span class="p">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">"No clusters detected"</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">rospy</span><span class="p">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">lastDetectionTime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">detectionTimeout</span><span class="p">:</span>
            <span class="n">humanPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">controlRosbot</span><span class="p">(</span><span class="n">humanPosition</span><span class="p">)</span>
    	<span class="k">else</span><span class="p">:</span>
            <span class="n">led</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">()</span>
            <span class="n">led</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">ledPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">rosbotControl</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">speedPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rosbotControl</span><span class="p">)</span>
    	<span class="k">return</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">clusterList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">clusterList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
    	<span class="n">led</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">()</span>
    	<span class="n">led</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">False</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">ledPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span> <span class="o">=</span> <span class="bp">True</span>
    	<span class="n">rosbotControl</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">speedPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rosbotControl</span><span class="p">)</span>
    	<span class="k">return</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>In here we check results of clusterization. If we didn’t detect anything, we continue movement in last seen human position. That is until our last seen position is too old - then we need to stop and assume we lost track of our human, which we signal through LED.<br />
We pass special value when obstacle is detected - in first cluster first point is set to (0,0). In this case robot needs to stop immediately, as obstacle is too close.</p>

<ul>
  <li><strong>detectionTimeout</strong> - how much time (in seconds) we can trust last seen position and follow it</li>
</ul>

<h3 id="2-leg-detection">2. Leg detection</h3>

<p>Next step is leg detection:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="n">sortedClusters</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">detectLegs</span><span class="p">(</span><span class="n">clusterList</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">detectLegs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clusterList</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sortedClusters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusterList</span><span class="p">:</span>
    	<span class="n">xMax</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">cluster</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    	<span class="n">xMin</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">cluster</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    	<span class="n">yMax</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">cluster</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    	<span class="n">yMin</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">cluster</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    	<span class="n">xDistance</span> <span class="o">=</span> <span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span>
    	<span class="n">yDistance</span> <span class="o">=</span> <span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span>
    	<span class="n">proportion</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xDistance</span><span class="p">,</span><span class="n">yDistance</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">xDistance</span><span class="p">,</span> <span class="n">yDistance</span><span class="p">)</span>
    	<span class="n">area</span> <span class="o">=</span> <span class="n">xDistance</span><span class="o">*</span><span class="n">yDistance</span>
    	<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xDistance</span><span class="p">,</span><span class="n">yDistance</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">legWidth</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">dLegWidth</span><span class="p">:</span>
    		<span class="k">continue</span>
    	<span class="n">xMean</span> <span class="o">=</span> <span class="p">(</span><span class="n">xMax</span><span class="o">+</span><span class="n">xMin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    	<span class="n">yMean</span> <span class="o">=</span> <span class="p">(</span><span class="n">yMax</span><span class="o">+</span><span class="n">yMin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    	<span class="n">cone</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
    	<span class="n">cone</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xMean</span>
    	<span class="n">cone</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">yMean</span>
    	<span class="n">cone</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
    	<span class="n">sortedClusters</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cone</span><span class="p">)</span>
    <span class="n">sortedClusters</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">.</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sortedClusters</span>
</code></pre></div></div>

<p>In this section we go through each cluster and calculate its bounding rectangle. Then we filter our data with following rule: longer side of rectangle can have maximal length of legWidth + dLegWidth (meaning that we assume leg width of legWidth with upper toleration dLegWidth). I encourage you to experiment with it and maybe try other conditions e.g. area and sides proportions. If cluster passes we find its centroid and save it for further calculations. As last thing we sort our potential legs by distance from ROSbot.</p>

<ul>
  <li><strong>legWidth</strong> - width of the leg</li>
  <li><strong>dLegWidth</strong> - toleration of leg width</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortedClusters</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    	<span class="n">rospy</span><span class="p">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">"No legs detected"</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">rospy</span><span class="p">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">lastDetectionTime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">detectionTimeout</span><span class="p">:</span>
            <span class="n">humanPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">controlRosbot</span><span class="p">(</span><span class="n">humanPosition</span><span class="p">)</span>
    	<span class="k">else</span><span class="p">:</span>
            <span class="n">led</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">()</span>
            <span class="n">led</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">ledPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">rosbotControl</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">speedPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rosbotControl</span><span class="p">)</span>
    	<span class="k">return</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>Similar to previous step we check results of leg detection. No legs found - we allow ROSbot to move for some time. This step is necessary to smooth out movement - sometimes in only one frame we don’t detect any legs, which can cause robot to stop and go.</p>

<h3 id="3-human-detection">3. Human detection</h3>

<p>We estimate human position through analysis of legs detections:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="p">(</span><span class="n">firstLeg</span><span class="p">,</span> <span class="n">secondLeg</span><span class="p">,</span> <span class="n">humanPosition</span><span class="p">,</span> <span class="n">firstLegDetected</span><span class="p">,</span> <span class="n">twoLegsDetected</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">detectHuman</span><span class="p">(</span><span class="n">sortedClusters</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">detectHuman</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sortedClusters</span><span class="p">):</span>
    <span class="n">firstLeg</span> <span class="o">=</span> <span class="n">sortedClusters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">firstLegDetected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">twoLegsDetected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">secondLeg</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
    <span class="n">humanPosition</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
    <span class="n">humanPositionTemp</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortedClusters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    	<span class="n">sortedClusters</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">firstLeg</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">firstLeg</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    	<span class="n">secondLeg</span> <span class="o">=</span> <span class="n">sortedClusters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    	<span class="n">legDistance</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">firstLeg</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">secondLeg</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">firstLeg</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">secondLeg</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">legDistance</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">legDistanceThreshold</span><span class="p">:</span>
            <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstLeg</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">secondLeg</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstLeg</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">secondLeg</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">twoLegsDetected</span> <span class="o">=</span> <span class="bp">True</span>
    	<span class="k">else</span><span class="p">:</span>
            <span class="n">humanPositionTemp</span> <span class="o">=</span> <span class="n">firstLeg</span>
    <span class="k">else</span><span class="p">:</span>
    	<span class="n">humanPositionTemp</span> <span class="o">=</span> <span class="n">firstLeg</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span><span class="p">:</span>
    	<span class="n">r</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">calibrationDistance</span> <span class="ow">and</span> <span class="n">twoLegsDetected</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span> <span class="o">=</span> <span class="n">humanPositionTemp</span>
            <span class="n">humanPosition</span> <span class="o">=</span> <span class="n">humanPositionTemp</span>
            <span class="n">firstLegDetected</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">lastDetectionTime</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">get_time</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">led</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">()</span>
            <span class="n">led</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">ledPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
    	<span class="n">distanceChange</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
    				<span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">humanPositionTemp</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    	<span class="k">if</span> <span class="n">distanceChange</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">humanPositionChangeThreshold</span><span class="p">:</span>
            <span class="n">humanPosition</span> <span class="o">=</span> <span class="n">humanPositionTemp</span>
            <span class="n">firstLegDetected</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span> <span class="o">=</span> <span class="n">humanPosition</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">lastDetectionTime</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">get_time</span><span class="p">()</span>
    	<span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rospy</span><span class="p">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">lastDetectionTime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">detectionTimeout</span><span class="p">:</span>
                <span class="n">humanPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lastHumanPosition</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">led</span> <span class="o">=</span> <span class="n">Bool</span><span class="p">()</span>
                <span class="n">led</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">ledPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">firstLeg</span><span class="p">,</span> <span class="n">secondLeg</span><span class="p">,</span> <span class="n">humanPosition</span><span class="p">,</span> <span class="n">firstLegDetected</span><span class="p">,</span> <span class="n">twoLegsDetected</span><span class="p">)</span>
</code></pre></div></div>

<p>We assume our first detected leg is one closest to ROSbot. Second leg (if any available) is one closest to first leg (if it’s close enough). With two legs detected we calculate possible human position as mean between legs, otherwise we use first leg as possible human position.<br />
When human position is not calibrated, then two legs have to be visible in range closer than given threshold. Provided that our position is already calibrated, we can check if our detected human position is viable. We calculate difference in positions between new and old detection, too big value means that it’s probably false detection. In this case we check if we can use older position, otherwise we lost track of human position.</p>

<ul>
  <li><strong>legDistanceThreshold</strong> - maximum distance from first leg to second leg, if second leg distance is more than that, we use only first leg detection</li>
  <li><strong>calibrationDistance</strong> - maximum distance from human to ROSbot to initialize position</li>
  <li><strong>humanPositionChangeThreshold</strong> - maximum distance between last detected human position and recent human position</li>
  <li><strong>detectionTimeout</strong> - how much time we can use old detection as human position, if we exceed this time we consider that we lost our human detection</li>
</ul>

<h3 id="4-marker-publishing">4. Marker publishing</h3>

<p>Visualization of our detections</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">publishMarkers</span><span class="p">(</span><span class="n">firstLeg</span><span class="p">,</span> <span class="n">secondLeg</span><span class="p">,</span> <span class="n">humanPosition</span><span class="p">,</span> <span class="n">firstLegDetected</span><span class="p">,</span> <span class="n">twoLegsDetected</span><span class="p">,</span> <span class="n">sortedClusters</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">publishMarkers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstLeg</span><span class="p">,</span> <span class="n">secondLeg</span><span class="p">,</span> <span class="n">humanPosition</span><span class="p">,</span> <span class="n">firstLegDetected</span><span class="p">,</span> <span class="n">twoLegsDetected</span><span class="p">,</span> <span class="n">sortedClusters</span><span class="p">):</span>
    <span class="n">legMarker</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">()</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"laser"</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="s">"person"</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">()</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">.</span><span class="n">CYLINDER</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">.</span><span class="n">ADD</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">lifetime</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span><span class="p">:</span>
    	<span class="c1">#first leg
</span>        <span class="k">if</span> <span class="n">firstLegDetected</span><span class="p">:</span>
            <span class="n">legMarker</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">firstLeg</span>
            <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.02</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">legPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">legMarker</span><span class="p">)</span>
        <span class="c1">#second leg
</span>        <span class="k">if</span> <span class="n">twoLegsDetected</span><span class="p">:</span>
            <span class="n">legMarker</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">secondLeg</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">legPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">legMarker</span><span class="p">)</span>
    	<span class="c1">#human position
</span>    	<span class="n">legMarker</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="mi">3</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.2</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">humanPosition</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.1</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="mf">1.0</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">0.0</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">legPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">legMarker</span><span class="p">)</span>
    <span class="n">legMarker</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">()</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">ns</span> <span class="o">=</span> <span class="s">"legs"</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s">"laser"</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Time</span><span class="p">()</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="nb">type</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">.</span><span class="n">SPHERE</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">.</span><span class="n">ADD</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">orientation</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">scale</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">g</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">color</span><span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">legMarker</span><span class="p">.</span><span class="n">lifetime</span> <span class="o">=</span> <span class="n">rospy</span><span class="p">.</span><span class="n">Duration</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sortedClusters</span><span class="p">:</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="nb">id</span> <span class="o">=</span> <span class="n">i</span>
    	<span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">x</span>
    	<span class="n">legMarker</span><span class="p">.</span><span class="n">pose</span><span class="p">.</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">y</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">legPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">legMarker</span><span class="p">)</span>
</code></pre></div></div>

<p>Pretty straightforward: we publish markers with potential legs (green spheres), detected legs (if any found, blue cylinders) and human (red cylinder).</p>

<h3 id="5-control">5. Control</h3>

<p>And final step is movement control:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scanCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
    <span class="p">...</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">controlRosbot</span><span class="p">(</span><span class="n">humanPosition</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">controlRosbot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">humanPosition</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">humanPosition</span><span class="p">.</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">humanPosition</span><span class="p">.</span><span class="n">y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">humanPosition</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">humanPosition</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">minHumanDistance</span><span class="p">:</span>
    	<span class="n">xSpeed</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">speedPGain</span>
    <span class="k">else</span><span class="p">:</span>
    	<span class="n">xSpeed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">minHumanAngle</span><span class="p">:</span>
    	<span class="n">zAngularSpeed</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">angularSpeedPGain</span>
    <span class="k">else</span><span class="p">:</span>
    	<span class="n">zAngularSpeed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rosbotControl</span> <span class="o">=</span> <span class="n">Twist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rospy</span><span class="p">.</span><span class="n">get_time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">buttonTime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">buttonTimeout</span> <span class="ow">and</span> \
    		<span class="bp">self</span><span class="p">.</span><span class="n">buttonState</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">positionCalibration</span><span class="p">:</span>
    	<span class="n">rosbotControl</span><span class="p">.</span><span class="n">linear</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xSpeed</span>
    	<span class="n">rosbotControl</span><span class="p">.</span><span class="n">angular</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">zAngularSpeed</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">speedPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rosbotControl</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
    	<span class="bp">self</span><span class="p">.</span><span class="n">speedPub</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">rosbotControl</span><span class="p">)</span>
</code></pre></div></div>

<p>Firstly we convert our cartesian coordinates to polar ones. Then we calculate angular and linear speed for ROSbot with proportional controller. We publish it if we receive message from remote that allow robot to move.</p>

<ul>
  <li><strong>minHumanDistance</strong> - if human distance is more than that robot will start following</li>
  <li><strong>minHumanAngle</strong> - if human angle is more than that robot will start following</li>
  <li><strong>speedPGain</strong> - proportional gain for linear ROSbot speed (increase if you want your robot to go faster)</li>
  <li><strong>angularSpeedPGain</strong> - proportional gain for angular ROSbot speed (increase if you want your robot to turn faster)</li>
  <li><strong>buttonTimeout</strong> (seconds) - if we don’t receive new Dead Man’s Button message for that time ROSbot isn’t allowed to move</li>
</ul>

<h3 id="followerkalman">FollowerKalman</h3>

<p>This version is improved slow follower - basically only additions are scoring system and Kalman filter. Also I changed some parameters to make it more suitable for higher speeds.<br />
In order to implement Kalman filter I created Person class where human position is stored and updated. For Kalman Filter part I used code from <a href="https://github.com/angusleigh/leg_tracker">leg_tracker</a>. All the parameters for filter were well tuned, I only changed std_obs value.</p>

<ul>
  <li><strong>std_obs</strong> - increasing this value means you don’t trust your measurements and as the effect your data is much more filtered. Be careful with changing it too much, because it causes your estimated human position to be slower to sudden changes - if you stop, filter won’t trust as much your readings and as a result it will predict you will still move with some velocity. Consequently robot will continue moving forward and it will take some time to adjust to reality. On the other hand if you decrease it too much human position will fluctuate with uncertainties in leg detections.</li>
</ul>

<p>Next big change is that I added scoring system which uses all parameters: proportion, area, length and distance. It combines it with appropriate weights.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">proportion</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xDistance</span><span class="p">,</span><span class="n">yDistance</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">xDistance</span><span class="p">,</span> <span class="n">yDistance</span><span class="p">)</span>
<span class="n">area</span> <span class="o">=</span> <span class="n">xDistance</span><span class="o">*</span><span class="n">yDistance</span>
<span class="n">widthDifference</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xDistance</span><span class="p">,</span><span class="n">yDistance</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">legWidth</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">dLegWidth</span>
<span class="n">distanceFromRobot</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xMean</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yMean</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">score</span> <span class="o">+=</span> <span class="n">distanceFromRobot</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">distanceWeight</span>
<span class="n">score</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">proportion</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">destProportion</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">proportionWeight</span>
<span class="n">score</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">area</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">destArea</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">areaWeight</span>
<span class="k">if</span> <span class="n">widthDifference</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">widthDifference</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">widthDifferenceWeight</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">maxScore</span><span class="p">:</span>
    <span class="n">sortedClustersDetails</span><span class="p">.</span><span class="n">append</span><span class="p">([</span><span class="n">xMean</span><span class="p">,</span> <span class="n">yMean</span><span class="p">,</span> <span class="n">distanceFromRobot</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">widthDifference</span><span class="p">,</span> <span class="n">score</span><span class="p">])</span>
</code></pre></div></div>

<p>Parameters:</p>

<ul>
  <li><strong>destProportion</strong> - our desired proportion, I set it based on readings I got</li>
  <li><strong>destArea</strong> - same as above but with area</li>
  <li><strong>distanceWeight</strong> - weight we give to distance from robot</li>
  <li><strong>proportionWeight</strong> - weight we set to distance between measured proportion and desired</li>
  <li><strong>areaWeight</strong> - don’t set this weight too high, as it is not as reliable</li>
  <li><strong>widthDifferenceWeight</strong> - we set it really high, because when reading is too long, then it’s probably not a leg</li>
  <li><strong>maxScore</strong> - above that score we are certain that detection isn’t a leg</li>
</ul>

<p>Parameters with updated values:</p>

<ul>
  <li><strong>minRange</strong> (increased) - robot has to detect obstacles earlier</li>
  <li><strong>speedPGain</strong> (increased) - increase in proportional gain to obtain higher speed</li>
  <li><strong>angularSpeedPGain</strong> (increased) - same as above</li>
  <li><strong>minHumanDistance</strong> (decreased) - robot will start following earlier and be able to keep up with human</li>
  <li><strong>humanPositionChangeThreshold</strong> (increased) - person walks faster so position can change more</li>
  <li><strong>detectionTimeout</strong> (decreased) - higher speeds, so we decrease timeouts</li>
  <li><strong>buttonTimeout</strong> (decreased) - same as above</li>
</ul>

<p>Lastly I added restrictions on obstacle detect - we only detect obstacle approximately in area where we can drive. Increasing minRange can cause ROSbot to be unable to move in narrow spaces.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">alfa</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">math</span><span class="p">.</span><span class="n">pi</span> <span class="ow">and</span> <span class="n">alfa</span> <span class="o">&lt;</span> <span class="o">-</span><span class="bp">self</span><span class="p">.</span><span class="n">maxAngle</span><span class="p">)</span> <span class="ow">or</span> \
	<span class="p">(</span><span class="n">alfa</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">maxAngle</span> <span class="ow">and</span> <span class="n">alfa</span> <span class="o">&lt;</span> <span class="n">math</span><span class="p">.</span><span class="n">pi</span><span class="p">):</span>
</code></pre></div></div>

<h2 id="summary">Summary</h2>

<p>In this tutorial you learned how to set up and run human following using ROSbot with ESP remote. After main algorithm walkthrough you should be also able to modify it to suit your robot.</p>


    <div class="share">
  
</div>


    


  </article>

  

</main>

<footer class="footer">
  <div class="container">
    <div class="copyright  typeset">
      <small class="small">&copy; Maciej Stępień 2023</small>
    </div>

    
<nav class="nav  nav--footer">
  <ul class="list list--nav">
    

      

      <li class="item  item--nav">
        <a href=""></a>
      </li>
    
  </ul>
</nav>


  </div>
</footer>



    <script type="text/javascript">
(() => {
  const registerServiceWorker = () => {
    if (!navigator.serviceWorker) {
      return;
    }

    navigator.serviceWorker
      .register("/sw.js")
      .then(registration => {
        console.log("Service Worker: registered");
      })
      .catch(err => {
        console.log("Service Worker: registration failed ", err);
      });
  };

  registerServiceWorker();
})();
</script>


    <!-- Overwrite this file with code you want before the closing body tag -->

  </body>

</html>
